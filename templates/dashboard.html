{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard - ArrendaU{% endblock %}

{% block extra_head %}
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="hero-image">
        <div class="hero-content">
            {% if user.rol == 'Arrendador' %}
                <h1>Gestiona tus Propiedades</h1>
                <p>Bienvenido, {{ user.nombre }} {{ user.apellido }}. Administra tus publicaciones y postulaciones.</p>
            {% else %}
                <h1>Encuentra tu espacio perfecto</h1>
                <p>Bienvenido, {{ user.nombre }} {{ user.apellido }}. Explora las mejores opciones de alojamiento.</p>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <!-- Filtros solo para Arrendatarios -->
        {% if not user.rol == 'Arrendador' %}
            <aside class="filters">
                <h2>Publicaciones Disponibles</h2>
                
                <!-- Filtros -->
                <div class="filter-group">
                    <label for="city">Ciudad</label>
                    <input type="text" id="city" placeholder="Ej: Medell√≠n">
                </div>

                <div class="filter-group">
                    <label>Rango de Precio</label>
                    <div class="range-container">
                        <div class="range-slider" id="range-slider">
                            <div class="range-selected"></div>
                        </div>
                        <div class="range-input">
                            <input type="range" class="min-price" min="0" max="400000" value="135000" step="1000">
                            <input type="range" class="max-price" min="0" max="400000" value="200000" step="1000">
                        </div>
                        <div class="range-price">
                            <span id="min-value">$0</span>
                            <span id="max-value">$200.000</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="rooms">Habitaciones</label>
                    <select id="rooms">
                        <option value="">Todas</option>
                        <option value="1">1 Habitaci√≥n</option>
                        <option value="2">2 Habitaciones</option>
                        <option value="3">3 Habitaciones</option>
                        <option value="4+">4+ Habitaciones</option>
                    </select>
                </div>
                <button class="btn-signup" style="width: 100%; margin-top: 1rem;">
                    Aplicar Filtros
                </button>
            </aside>
        {% else %}
            <!-- Panel para Arrendadores -->
            <aside class="filters">
                <a href="{% url 'ArrendaU_publicaciones_app:crear_publicacion' %}" class="btn-create">
                    Crear publicaci√≥n
                </a>
                <h2>Mis Publicaciones</h2>
            </aside>
        {% endif %}

        <main class="listings">
            {% for publicacion in publicaciones %}
            <article class="property-card" data-publication-id="{{ publicacion.id }}">
                <div class="property-actions">
                    {% if user.rol == 'Arrendador' and user == publicacion.usuario %}
                        <a href="{% url 'ArrendaU_publicaciones_app:editar_publicacion' publicacion.id %}" class="btn-action btn-edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" 
                                class="btn-action btn-delete" 
                                onclick="showDeleteModal('{{ publicacion.id }}')" 
                                title="Eliminar"
                                data-id="{{ publicacion.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
                {% if publicacion.fotos.all %}
                    <img src="{{ publicacion.fotos.first.imagen.url }}" alt="{{ publicacion.titulo }}" class="property-image">
                {% else %}
                    <img src="{% static 'img/default_image.jpg' %}" alt="Imagen no disponible" class="property-image">
                {% endif %}
                <div class="property-details">
                    <h3 class="property-title">{{ publicacion.titulo }}</h3>
                    <div class="property-info">
                        <span>üìç {{ publicacion.ciudad }}</span>
                        <span>üí∞ {{ publicacion.valor_alquiler|format_precio }}</span>
                        <span>üõèÔ∏è {{ publicacion.habitaciones_disponibles }} habitaciones</span>
                    </div>
                    <p class="property-description">
                        {{ publicacion.descripcion }}
                    </p>
                    <div style="color: var(--text-secondary);">
                        {{ publicacion.direccion }}
                    </div>
                </div>
            </article>
            {% empty %}
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    {% if user.rol == 'Arrendador' %}
                        <p>No has creado ninguna publicaci√≥n a√∫n.</p>
                        <a href="{% url 'ArrendaU_publicaciones_app:crear_publicacion' %}" class="btn-create" style="margin-top: 1rem;">
                            Crear mi primera publicaci√≥n
                        </a>
                    {% else %}
                        <p>No hay publicaciones disponibles en este momento.</p>
                    {% endif %}
                </div>
            {% endfor %}
        </main>
    </div>

    <!-- Modales -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Confirmar Eliminaci√≥n</h2>
            <p>¬øEst√°s seguro de que deseas eliminar esta publicaci√≥n?</p>
            <form id="deleteForm">
                {% csrf_token %}
                <div class="modal-buttons">
                    <button type="button" onclick="confirmDelete()" class="btn-delete">Eliminar</button>
                    <button type="button" onclick="hideDeleteModal()" class="btn-cancel">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notificationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="notificationTitle"></h2>
            <p id="notificationMessage"></p>
            <div class="modal-buttons">
                <button onclick="hideNotificationModal()" class="btn-signup">Aceptar</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}